#!/bin/sh

readonly THIS_DIR=$(dirname $0)
. $THIS_DIR/../webpipe-lib.sh

checkDeps() {
  local msg="dot not found.  Run 'sudo apt-get install graphviz'"
  which dot >/dev/null || die $msg
}

# changes:
# rename to scroll?
# ./render scroll foo.html 33

main() {
  # $input=$1         # absolute path.  NOT SAFE for html.
  # $output_htmlsafe  # guaranteed to be safe, since it's just a number.
  #
  # $WP_INPUT_HTMLSAFE - filename passed through cgi.escape(quote=T)
  #
  # local outputDir=$outputHtmlSafe

  local input="$1"  # can have spaces
  local output=$2
  local output_dir=$3

  checkDeps

  # fail if dot fails, etc.
  set -o errexit

  log "input $input"

  # These must be RELATIVE, so you can use them as URLs too!
  log "output $output"  # 1.html
  log "output_dir $output_dir"  #1/

  # Script is responsible for this!  I think.
  mkdir -p $output_dir

  local out_png="$output_dir/$(WP_BasenameNoExt $input).png" 
  dot -T png -o "$out_png" "$input"

  echo $output_dir  # we wrote it

  # TODO: Use jsont here.
  cat >$output <<EOF
<p>
  <i>Dot file</i>
  <a href="$output_dir">$output_dir</a>
  <img src="$out_png">rendered dot image</img>
</p>
EOF
}

main "$@"

