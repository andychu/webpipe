#!/bin/sh

readonly THIS_DIR=$(dirname $0)
. $THIS_DIR/../webpipe-lib.sh

checkDeps() {
  local msg="dot not found.  Run 'sudo apt-get install graphviz'"
  which dot >/dev/null || die $msg
}

main() {
  local action=$1
  if test $action != "scroll"; then
    die "Invalid action '$action'"
  fi
  local input=$2
  local output=$3

  checkDeps

  # fail if dot fails, etc.
  set -o errexit

  mkdir -p $output

  local pngOut="$output/$(WP_BasenameNoExt $input).png"
  dot -T png -o $pngOut $input

  local inputFilename=$(basename $input)
  local origOut=$output/$inputFilename.txt

  cp $input $origOut

  echo $output  # finished writing directory

  cat >$output.html <<EOF
<p>
  <a href="$origOut">$inputFilename.txt</a>
  <center>
    <img src="$pngOut" alt="Rendered dot image" />
  </center>
</p>
EOF

  echo $output.html  # wrote it
}

main "$@"
